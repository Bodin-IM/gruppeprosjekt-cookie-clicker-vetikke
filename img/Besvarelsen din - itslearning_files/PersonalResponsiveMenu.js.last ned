'use strict';function PersonalResponsiveMenuInit(m){function k(a){jQuery.ajax({type:"GET",url:K.personalMessageSourceUrl,success:function(b){E=b;L=new Date;f.updateMessageCounterBasedOnCookie();a&&h(b)},error:CommonFunctions.alertAjaxError})}function h(a){c.messageDialogContent.empty().html(a);a=-(c.inboxMenuLink.width()/2+ +c.inboxMenuLink.css("padding-right").replace("px","")+ +c.inboxMenuLink.css("border-right-width").replace("px","")+ +c.inboxMenuLink.css("margin-right").replace("px",""));var b=
-(c.inboxMenuLink.height()/2+ +c.inboxMenuLink.css("padding-bottom").replace("px","")+ +c.inboxMenuLink.css("border-bottom-width").replace("px","")+ +c.inboxMenuLink.css("margin-bottom").replace("px",""));p.openDialogAt(a,b,!0);e.isAndroidBrowser||A();c.inboxMenuLink.closest("li").toggleClass(B.opaque,!0);u();v()}function w(){M&&clearTimeout(M);M=setTimeout(A,200)}function A(){var a=c.messageDialogContent,b=C.height()-a.offset().top-(a.outerHeight(!0)-a.height());a.css({"max-height":0>b?0:b,"overflow-y":"auto"})}
function F(a){p=D(a,c.inboxMenuLink,c.messageDialogContent);p.setBeforeCloseDialog(function(){var b=c.inboxMenuLink.closest("li"),g=!!c.messagesBadge.text();b.toggleClass(B.opaque,g)});p.hideHeader();p.hideFooter();p.toggleCloseLink(!1)}function D(a,b,g){a.toggleElement=b;return new ContextDialog(g,a)}function d(a,b,g,n){b.closest("li").toggleClass(B.opaque,n);g.text(G(a,!0));g.toggle(0<a)}function v(){c.messageDialogContent.find("#"+e.messageCounterIds.internalMessagesCounter).text(N(G(r)))}function u(){if(!window.itslearning.settings.app.is_instant_message_system_enabled){var a=
e.primaryCloudEmailType===CloudEmailType.office365?N(G(x,!1)):N(G(y,!1));c.messageDialogContent.find("#"+e.messageCounterIds.cloudMessagesCounter).text(a)}}function G(a,b){return void 0===a||0>=a?"":b&&100<=a?"99+":a}function N(a){return""===a?"":" ("+a+")"}function U(a,b,g,n){var O=a?"touchstart":"click",P=g.find("li:first-child > button");g.find("a").click(function(){g.hide();n&&n()});b.on(O+" keydown",function(l){if(l.type===O||l.which===CCL.CommonConstants.keyCodes.arrowDown)"false"===$(".c-messages-popup").attr("aria-hidden")&&
$(".c-messages__overlay").click(),g.toggle(),P.focus()});$(document).on(O+" "+CCL.CommonTriggers.clickInInnerFrame,function(l){if(g.is(":visible")){l=l.target;var H=$(l),R=l===b.get(0)||1===H.closest(b).length;H=!R&&(l===g.get(0)||1===H.closest(g).length);var S=g.find("li:last-child > a");R||H||(g.hide(),window.FreshdeskChat&&window.FreshdeskChat.destroy(),n&&n());S.keydown(l,function(t){t.which!==CCL.CommonConstants.keyCodes.tab||t.shiftKey||(t.preventDefault(),P.focus())});P.keydown(l,function(t){t.shiftKey&&
t.which===CCL.CommonConstants.keyCodes.tab&&(t.preventDefault(),S.focus())})}});g.keydown(function(l){l.which===CCL.CommonConstants.keyCodes.escape&&($(g).hide(),n&&n(),b.focus())})}window[m]=this;var f=this,C=jQuery(window),c,e,K,B,z,p,M,Q=0,q=0,x=0,y=0,r=0,T,E,I=0,L,J;f.initialize=function(){c=f.controls;e=f.settings;K=f.settings.urls;B=f.settings.cssClasses;z=f.settings.queryStringParameters;J=f.toggleMenuLinkFunction;c.personalMenuLink.on("click",function(){"false"===jQuery(InstantMessageSelectors.popupSelector).attr("aria-hidden")&&
jQuery(InstantMessageSelectors.overlaySelector).click();J()});var a=document.querySelector("button[name=closePersonalMenu]");a&&a.addEventListener("click",function(){c.personalMenuDropDown.hide();J();c.personalMenuLink.focus()});U(e.isIos,c.personalMenuLink,c.personalMenuDropDown,J);c.searchBoxMobile.on("click touchstart touchend",function(b){b.stopPropagation()});c.searchBoxMobile.on(e.searchTextEvent,function(b,g){itslTop.location.href=K.searchMainPageNavigateUrl.replace(e.searchPlaceholder,encodeURIComponent(encodeURIComponent(g)))});
e.shouldOpenMessagesPopUp&&(c.inboxMenuLink.click(function(b){p.isOpened()?p.closeDialog():((b=!E)||(b=L?18E4<(new Date).getTime()-L.getTime():!1),b?k(!0):h(E))}),e.isAndroidBrowser||C.resize(w),C.on("load",function(){k()}));d(0,c.notificationLink,c.notificationsBadge,!1);d(0,c.office365CloudEmailIconLink,c.office365CloudEmailBadge,!1);d(0,c.gmailCloudEmailIconLink,c.gmailCloudEmailBadge,!1);d(0,c.inboxMenuLink,c.messagesBadge,!1);d(0,c.emailMenuLink,c.emailBadge,!1);CommonFunctions.attachPostMessageEventListener(C,
CommonWindowMessages.MessageNames.unseenNotificationCounterChanged,function(b){d(b.extendedData,c.notificationLink,c.notificationsBadge,!!(0<b.extendedData))});CommonFunctions.attachPostMessageEventListener(C,CommonWindowMessages.MessageNames.openGroupChat,function(b){if(window.itslearning.settings.app.enableModernInstantMessages)setTimeout(()=>window.dispatchEvent(new CustomEvent("openCollaborationThread",{detail:{collaborationId:b.collaborationId}})),50);else{const g="true"===jQuery(InstantMessageSelectors.popupSelector).attr("aria-hidden"),
n=jQuery("#l-header").is(":hidden");g&&"function"===typeof window.InstantMessageOpenWindowForCollaboration&&window.InstantMessageOpenWindowForCollaboration(b.collaborationId,function(){jQuery(InstantMessageSelectors.popupSelector).attr("aria-hidden","false");jQuery(InstantMessageSelectors.overlaySelector).removeClass("is-hidden")},n)}});e.shouldOpenMessagesPopUp&&F({width:400,setFocus:!1,marginTop:38,marginBottom:0,noTitle:!0,showArrow:!0,align:"center",valign:"bottom",closeButtonTooltip:f.settings.terms.close,
cssClass:B.popupContainer,customScripts:{beforeCloseDialog:null}});e.hasInternalMessages&&(T=new RegExp("[\\?&]"+e.onlineInfoCookie.unreadMessagesKey+"=([^&#]*)"))};f.setUnreadInternalMessages=function(a){e.hasInternalMessages&&a!==q&&(q=a,v())};f.setUnreadEmailMessages=function(a,b){e.hasEmail&&a!==r&&(r=a,I=b)};f.setUnreadCloudEmailMessages=function(a,b){!e.hasCloudEmail||x===a&&y===b||(x=a,y=b,u())};f.updateMessageCounterBasedOnCookie=function(){if(e.hasInternalMessages){var a=T.exec(jQuery.cookie(e.onlineInfoCookie.name));
a&&a.length&&(q=parseInt(a[1]),f.setCounts())}};f.setCounts=function(){Q&&q!==Q&&f.invalidateCache();if(I&&0<I&&window.itslearning.settings.app.is_instant_message_system_enabled){var a=f.controls.emailMenuLink.attr("href"),b=a.getQueryStringParameter(z.textURL);b=b.setQueryStringParameter(z.emailAccountsRedirect,"False");b=b.setQueryStringParameter(z.emailRedirect,"True");b=b.setQueryStringParameter(z.accountID,I);f.controls.emailMenuLink.attr("href",a.setQueryStringParameter(z.textURL,b))}Q=q;a=
0;0<q&&(e.hasInternalMessages||e.hasEmail)&&(a+=q,window.itslearning.settings.app.is_instant_message_system_enabled&&(window.itslearning.instantmessaging.unreadInternalMessages=q));(0<x||0<y)&&e.hasCloudEmail&&(window.itslearning.settings.app.is_instant_message_system_enabled?(d(x,c.office365CloudEmailIconLink,c.office365CloudEmailBadge,!1),d(y,c.gmailCloudEmailIconLink,c.gmailCloudEmailBadge,!1)):a=e.primaryCloudEmailType===CloudEmailType.office365?a+x:a+y);!window.itslearning.settings.app.is_instant_message_system_enabled&&
e.hasEmail&&(a+=r);0<r&&e.hasEmail&&d(r,c.emailMenuLink,c.emailBadge,!!(0<r));if(e.hasInternalMessages||e.hasCloudEmail||e.hasEmail)b=0<a||f.settings.shouldOpenMessagesPopUp&&p.isOpened(),d(a,c.inboxMenuLink,c.messagesBadge,!!b);CommonFunctions.makePostMessageCall(window.itslTop,new CommonWindowMessages.GenericMessageWithData(CommonWindowMessages.MessageNames.unseenNotificationCounterChanged,f.unseenNotifications));window.itslearning.settings.app.is_instant_message_system_enabled&&(a=jQuery.Event("UpdateUnreadMessagesCount"),
jQuery(window).trigger(a))};f.invalidateCache=function(){E=void 0};return f}var CloudEmailType={office365:"Office365",gmail:"Gmail"},InstantMessageSelectors={largeHeaderLogo:".l-logo",mainMenuSelector:"ul.l-main-menu-items",overlayClass:"c-messages__overlay",overlaySelector:".c-messages__overlay",overlayLargeSelector:"c-messages__overlay--largeHeader",overlayBlackClass:"c-messages__overlay--black",popupSelector:".c-messages-popup",popupIconSelector:".l-personal-menu-instantmessage",popupIconSelectedClass:"l-personal-menu-icon-instantmessage-selected"};
function FlyOutPopupInit(m){jQuery(InstantMessageSelectors.popupSelector).load(m);jQuery("body").append('<div class="'+InstantMessageSelectors.overlayClass+' is-hidden"></div>');0<jQuery(InstantMessageSelectors.largeHeaderLogo).length&&jQuery(InstantMessageSelectors.overlaySelector).addClass(InstantMessageSelectors.overlayLargeSelector);jQuery(InstantMessageSelectors.popupIconSelector).on("click",function(){var k=jQuery(this);"true"===jQuery(InstantMessageSelectors.popupSelector).attr("aria-hidden")?
(jQuery(InstantMessageSelectors.popupSelector).attr("aria-hidden","false"),jQuery(InstantMessageSelectors.overlaySelector).removeClass("is-hidden"),jQuery(InstantMessageSelectors.mainMenuSelector).on("click",function(h){jQuery(InstantMessageSelectors.mainMenuSelector).off("click");"false"===jQuery(InstantMessageSelectors.popupSelector).attr("aria-hidden")&&jQuery(InstantMessageSelectors.overlaySelector).click()}),"undefined"!==typeof window.InstantMessageOpenWindow&&window.InstantMessageOpenWindow()):
jQuery(InstantMessageSelectors.overlaySelector).click();jQuery(k).closest("li").toggleClass(InstantMessageSelectors.popupIconSelectedClass)});jQuery(InstantMessageSelectors.overlaySelector).on("click",function(k){k=jQuery(k.target);if(k.hasClass(InstantMessageSelectors.overlayClass)||k.hasClass(InstantMessageSelectors.overlayBlackClass))jQuery(this).closest("li").toggleClass(InstantMessageSelectors.popupIconSelectedClass),jQuery(InstantMessageSelectors.overlaySelector).removeClass(InstantMessageSelectors.overlayBlackClass),
jQuery(InstantMessageSelectors.overlaySelector).addClass("is-hidden"),jQuery(InstantMessageSelectors.popupSelector).attr("aria-hidden","true"),"undefined"!==typeof window.InstantMessageCloseWindow&&window.InstantMessageCloseWindow()})}
function OpenInstantMessageSendNew(m){window.itslearning.settings.app.enableModernInstantMessages?setTimeout(()=>window.dispatchEvent(new CustomEvent("showNewMessageWithPreSelectedRecipients",{detail:m})),50):"undefined"!==typeof window.showInstantMessageSendNew&&(jQuery(InstantMessageSelectors.popupSelector).attr("aria-hidden","false"),jQuery(InstantMessageSelectors.popupIconSelector).closest("li").addClass(InstantMessageSelectors.popupIconSelectedClass),jQuery(InstantMessageSelectors.overlaySelector).removeClass("is-hidden"),
window.showInstantMessageSendNew(m))}function OpenInstantMessageModal(){"undefined"!==typeof window.InstantMessageOpenModalWindow?openInstentMessageModalWindow():window.setTimeout(openInstentMessageModalWindow,3E3)}
function openInstentMessageModalWindow(){"undefined"!==typeof window.InstantMessageOpenModalWindow&&(jQuery(InstantMessageSelectors.popupSelector).attr("aria-hidden","false"),jQuery(InstantMessageSelectors.popupIconSelector).closest("li").addClass(InstantMessageSelectors.popupIconSelectedClass),jQuery(InstantMessageSelectors.overlaySelector).removeClass("is-hidden"),window.InstantMessageOpenModalWindow())}
jQuery(()=>{if(window.itslearning.settings.app.is_instant_message_system_enabled){let m=0,k;const h=(new signalR.HubConnectionBuilder).withUrl(itslearning.settings.app.signalRUrl,{skipNegotiation:!0,transport:signalR.HttpTransportType.WebSockets}).configureLogging(signalR.LogLevel.Warning).withAutomaticReconnect().build(),w=d=>{jQuery(window).trigger(jQuery.Event("SignalRConnectionStatus"),d);window.dispatchEvent(new CustomEvent("SignalRConnectionStatus2",{detail:{status:d}}))};"undefined"!==typeof h&&
null!==h&&(h.on("AlertNewMessage",d=>{d=JSON.parse(d);jQuery(window).trigger(jQuery.Event("NewSignalRInstantMessage"),d);window.dispatchEvent(new CustomEvent("NewSignalRInstantMessage2",{detail:{thread:d}}))}),h.on("AlertThreadDeleted",d=>{jQuery(window).trigger(jQuery.Event("SignalRThreadDeleted"),d)}));const A=d=>{let v="";localStorage.getItem("instantmessage-channelid")&&(v=localStorage.getItem("instantmessage-channelid"));let u="/restapi/personal/instantmessages/communicationchannel/{channelId}/v1".replace("{channelId}",
d);5<v.length&&(u=`${u}?unregister=${v}`);CCL.CommonFunctions.safeAjaxPost({url:u,headers:{[itslearning.settings.app.antiForgeryHeaderName]:itslearning.settings.app.antiForgeryHeaderValue}}).done(()=>{w(!0);console.log(`SignalR connection registered. ChannelId: ${d}`);D(!1)}).fail(()=>console.log(`SignalR connection could not be registered. ChannelId: ${d}`));localStorage.setItem("instantmessage-channelid",d)},F=()=>h.start().then(()=>h.invoke("GetConnectionId")).then(d=>A(d)).catch(d=>{w(!1);D(!0);
console.log(`Error starting SignalR connection. ChannelId: ${d}`)}),D=d=>{d?10>=m&&(m+=1,window.clearInterval(k),k=window.setInterval(F,3E4)):(window.clearInterval(k),m=0)};F();h.onreconnecting(()=>{w(!1);console.log("SignalR connection reconnecting.")});h.onclose(()=>{w(!1);console.log("SignalR connection disconnected.");D(!0)});h.onreconnected(()=>{console.log("SignalR connection reconnected. Trying to get ChannelId.");h.invoke("GetConnectionId").then(d=>{console.log(`SignalR connection reconnected. New ChannelId: ${d}`);
A(d)})})}});
